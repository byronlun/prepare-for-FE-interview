# 性能优化

标签： 性能 前端

---

前端性能优化可以从**客户端性能**，**网络**，**服务端**来考虑，当然


目录：

- [页面内容](#1)
    - [减少 HTTP 请求数](#1.1)
    - [减少 DNS 查询](#1.2)
    - [避免重定向](#1.3)
    - [缓存 Ajax 请求](#1.4)
    - [延迟加载](#1.5)
    - [减少 DOM 元素数量](#1.6)
    - [划分内容到不同域名](#1.7)
    - [尽量减少 iframe 使用](#1.8)
- [服务器](#2)
    - [使用 CDN](#2.1)
    - [添加 Expires 或 Cache-Control 响应头](#2.2)
    - [启用 Gzip](#2.3)
    - [配置 Etag](#2.4)
    - [Ajax 请求首选 GET 方法](#2.5)
    - [避免图片 src 为空](#2.6)
- [Cookie](#3)
- [CSS](#4)
    - [把样式表放在 <head> 中](#4.1)
    - [不要使用 CSS 表达式](#4.2)
- [JavaScript](#5)
    - [把脚本放在页面底部](#5.1)
    - [减少 DOM 操作](#5.2)
    - [使用外部 JavaScript 和 CSS](#5.3)
    - [压缩 JavaScript 和 CSS](#5.4)
- [图片](#6)
    - [压缩图片](#6.1)
    - [CSS Sprites](#6.2)
    

## 1.页面内容

### <h3 id="1.1">减少 HTTP 请求数</h3>

> 雅虎: Web 前端 80% 的响应时间花在图片、样式、脚本等资源下载上。浏览器对每个域名的连接数是有限制的，减少请求次数是缩短响应时间的关键。

基本原理：在浏览器与服务器进行通信时，主要是通过 HTTP 进行通信。浏览器与服务器需要经过三次握手，每次握手需要花费大量时间。而且不同浏览器对资源文件并发请求数量有限（不同浏览器允许并发数），一旦 HTTP 请求数量达到一定数量，资源请求就存在等待状态，这是很致命的，因此减少 HTTP 的请求数量可以很大程度上对网站性能进行优化。

- 合并 JavaScript、CSS 等文件；
    - 服务器端自动合并（CDN 的 [Combo 技术](https://yuiblog.com/blog/2008/07/16/combohandler/)能把多个资源文件合并引用，据说淘宝 cdn [使用了](http://www.cnblogs.com/zhengyun_ustc/archive/2012/07/18/combo.html)）
    - 基于 `NodeJS` 的文本合并工具也是一堆： `grunt`，`gulp`， `webpack` 等
- 使用 CSS Sprites：将背景图片合并成一个文件，通过 `background-image` 和 `background-position` 控制显示，就是我们常说的雪碧图了；

>HTTP/2 通过多路复用大幅降低了多个请求的开销。通过数据分帧层，客户端和服务器之间只需要建立一个 TCP 连接，即可同时收发多个文件，而且，该连接在相当长的时间周期内保持打开（持久化），以便复用。

>HTTP/2 针对多个请求进行了优化，因此我们在前端中所做的**关于减少HTTP请求的优化实践**都不再适用，但考虑到客户端对 HTTP/2 的支持覆盖程度，还需根据实际数据权衡。

更多关于HTTP/2的了解，可以参考[简述HTTP/2的特性及其对前端的影响](http://hectorguo.com/zh/http2-starter/)了解

### <h3 id="1.2">减少 DNS 查询</h3>

>雅虎： 用户输入 URL 以后，浏览器首先要查询域名（hostname）对应服务器的 IP 地址，一般需要耗费 20-120 毫秒 时间。DNS 查询完成之前，浏览器无法从服务器下载任何数据。

基于性能考虑，ISP、局域网、操作系统、浏览器都会有相应的 DNS 缓存机制。

- IE 缓存 30 分钟，可以通过注册表中 DnsCacheTimeout 项设置；
- Firefox 混存 1 分钟，通过 network.dnsCacheExpiration 配置；

首次访问、没有相应的 DNS 缓存时，域名越多，查询时间越长。所以应尽量减少域名数量。但基于并行下载考虑，把资源分布到 2 个域名上（最多不超过 4 个）。这是减少 DNS 查询同时保证并行下载的折衷方案。

### <h3 id="1.3">避免重定向</h3>

HTTP 重定向通过 301/302 状态码实现。

```js
HTTP/1.1 301 Moved Permanently  
Location: http://example.com/newuri  
Content-Type: text/html  
```

客户端收到服务器的重定向响应后，会根据响应头中 Location 的地址再次发送请求。重定向会影响用户体验，尤其是多次重定向时，用户在一段时间内看不到任何内容，只看到浏览器进度条一直在刷新。

### <h3 id="1.4">缓存 Ajax 请求</h3>

Ajax 可以提高用户体验。但「异步」不意味着「及时」，优化 Ajax 响应速度提高性能仍是需要关注的主题。

最重要的的优化方式是**缓存响应结果**，详见 [添加 Expires 或 Cache-Control 响应头]()。

以下规则也关乎 Ajax 响应速度:

- 启用 Gzip
- 减少 DNS 查询
- 压缩 JavaScript 和 CSS
- 避免重定向
- 配置 Etag


### <h3 id="1.5">延迟加载</h3>

页面初始加载时哪些内容不是必需的？比如：

- 非首屏使用的数据、样式、脚本、图片等；
- 用户交互时才会显示的内容。

遵循「渐进增强」理念开发的网站：JavaScript 用于增强用户体验，但没有（不支持） JavaScript 也能正常工作，完全可以延迟加载 JavaScript。

> **延迟渲染**

> 将首屏以外的 HTML 放在不渲染的元素中，如隐藏的 `<textarea>`，或者 `type` 属性为非执行脚本的 `<script>` 标签中，减少初始渲染的 DOM 元素数量，提高速度。等首屏加载完成或者用户操作时，再去渲染剩余的页面内容。

**使用 `<textarea>` 的原理**: 使用 `<textarea>` 标签包裹 HTML/JS/CSS 代码, 当作 `<textarea>` 的 value 值, 在页面渲染的时候实际并没有渲染到 DOM 树上, 而是与图片懒加载类似, 当 `<textarea>` 标签出现或即将出现在用户视野时, 将 `<textarea>` 中的 HTML 代码取出, 用 innerHTML 动态插入到 DOM 树中, 如有必要使用正则取出 js/css 代码动态执行。

**优点**

-  减少首屏DOM渲染
-  加快首屏加载速度
-  分块加载js/css(使用于模块区分度高的网站)

**缺点**

- 需要更改 DOM 结构
- 可能引起一些重排和重绘
- 没有开启 JS 功能的用户将看不到延迟加载的内容
- 额外性能损耗(渲染前的 `<textarea>` 里面的 html 代码，在服务端把 html 代码保存在隐藏的 textarea 里面，所以在服务端会把 html 代码转义，尖括号等都被转义了，会增加服务端的压力,而且这个改造只是前端的渲染，服务器依旧是一次计算所有的数据，输出所有的数据。一般使用都是由后端拼接成 html 字符串然后塞入 `<textarea>` 标签, 吐给前端)
- 不利于 SEO (在搜索引擎看来网页也缺少了关键的 DOM 节点，原本信息量丰富的网页内容被放入单个的 `<textarea>` 里面， 使搜索引擎认为网页内容贫乏，大幅影响排名情况)

### <h3 id="1.6">减少 DOM 元素数量</h3>

复杂的页面不仅下载的字节更多，JavaScript DOM 操作也更慢。例如，同是添加一个事件处理器，500 个元素和 5000 个元素的页面速度上会有很大区别。

从以下几个角度考虑移除不必要的标记：

- 是否还在使用表格布局？
- 塞进去更多的 <div> 仅为了处理布局问题？也许有更好、更语义化的标记。
- 能通过伪元素实现的功能，就没必要添加额外元素，如清除浮动。


> 为什么不使用表格布局？

>- 更多的标签，增加文件大小；
- 不易维护，无法适应响应式设计；
- 性能考量，默认的表格布局算法会产生大量重绘（参见表格布局算法）。


### <h3 id="1.7">划分内容到不同域名</h3>

浏览器一般会限制每个域的并行线程（一般为 6 个，甚至更少），使用不同的域名可以最大化下载线程，但注意保持在 2-4 个域名内，以避免 DNS 查询损耗。

例如，**动态内容(CSS，JS 文件)放在 `cssjs.com` 上，静态资源（图片）放在 `img.com` 上。这样还可以禁用静态资源域下的 Cookie，减少数据传输**。

###  <h3 id="1.8">尽量减少 iframe 使用</h3>

**`<iframe>` 优点：**

- 可以用来加载速度较慢的第三方资源，如广告、徽章；
- 可用作安全沙箱；
- 可以并行下载脚本。

**<iframe> 缺点：**

- 加载代价昂贵，即使是空的页面；
- 阻塞页面 load 事件触发；
- 缺乏语义。

## 服务器

### <h3 id="2.1">使用 CDN(Content Delivery Network)</h3>

相比分布式架构的复杂和巨大投入，**静态内容分发网络（CDN）可以以较低的投入，获得加载速度有效提升**。

**致命的缺点就是内容更新的实时性不太好**。

###  <h3 id="2.2">添加 Expires 或 Cache-Control 响应头</h3>

- 静态内容：将 `Expires` 响应头设置为将来很远的时间，实现「永不过期」策略；
- 动态内容：设置合适的 `Cache-Control` 响应头，让浏览器有条件地发起请求。

更多关于浏览器缓存知识可以参考[缓存笔记](https://github.com/byronlun/prepare-for-FE-interview/blob/master/others/%E7%BC%93%E5%AD%98%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.md)

###  <h3 id="2.3">启用 Gzip</h3>

Gzip 压缩通常可以减少 70% 的响应大小，对某些文件更可能高达 90%，比 Deflate 更高效。主流 Web 服务器都有相应模块，而且绝大多数浏览器支持 gzip 解码。所以，应该对 HTML、CSS、JS、XML、JSON 等文本类型的内容启用压缩。

### <h3 id="2.4">配置 Etag</h3>

Etag 通过文件版本标识，方便服务器判断请求的内容是否有更新，如果没有就响应 304，避免重新下载。

更多关于协商缓存知识可以参考[缓存笔记](https://github.com/byronlun/prepare-for-FE-interview/blob/master/others/%E7%BC%93%E5%AD%98%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.md)

### <h3 id="2.5">Ajax 请求首选 GET 方法</h3>

浏览器执行 XMLHttpRequest POST 请求时分成两步，先发送 Header，再发送数据。而 GET 只使用一个 TCP 数据包发送数据，所以首选 GET 方法。

IE 中最大 URL 长度为 2K，如果超出 2K，则需要考虑使用 POST 方法。

### <h3 id="2.6">避免图片 src 为空</h3>

虽然 src 属性为空字符串，但浏览器仍然会向服务器发起一个 HTTP 请求，

- 给服务器造成意外的流量负担，尤其时日 PV 较大时；
- 浪费服务器计算资源；
- 可能产生报错。

空的 href 属性也存在类似问题。用户点击空链接时，浏览器也会向服务器发送 HTTP 请求，可以通过 JavaScript 阻止空链接的默认的行为。

## <h2 id="3">Cookie</h2>

Cookie 被用于身份认证、个性化设置等诸多用途。Cookie 通过 HTTP 头在服务器和浏览器间来回传送，**减少 Cookie 大小**可以降低其对响应速度的影响。

- 去除不必要的 Cookie；
- 尽量压缩 Cookie 大小；
- 注意设置 Cookie 的 domain 级别，如无必要，不要影响到 sub-domain；
- 设置合适的过期时间。

还有一个关于 Cookie 的优化处理：**静态资源使用无 Cookie 域名**。
静态资源一般无需使用 Cookie，可以把它们放在使用二级域名或者专门域名的无 Cookie 服务器上，降低 Cookie 传送的造成的流量浪费，提高响应速度。

## <h2 id="4">CSS</h2>

### <h3 id="4.1">把样式表放在 `<head>` 中</h3>

把样式表放在 <head> 中可以让页面渐进渲染，尽早呈现视觉反馈，给用户加载速度很快的感觉。

这对内容比较多的页面尤为重要，用户可以先查看已经下载渲染的内容，而不是盯着白屏等待。

如果把样式表放在页面底部，一些浏览器为减少重绘，会在 CSS 加载完成以后才渲染页面，用户只能对着白屏干瞪眼，用户体验极差。

###  <h3 id="4.2">不要使用 CSS 表达式</h3>

CSS 表达式可以在 CSS 里执行 JavaScript，仅 IE5-IE7 支持，IE8 标准模式已经废弃。

所以，现在基本没人用，可以忽略这一点优化。

## <h2 id="5">JavaScript</h2>

###  <h3 id="5.1">把脚本放在页面底部</h3>

浏览器下载脚本时，会阻塞其他资源并行下载，即使是来自不同域名的资源。因此，最好将脚本放在底部，以提高页面加载速度。

一些特殊场景无法将脚本放到页面底部的，可以考虑  `<script>` 的以下属性：

- `defer` 属性
- HTML5 新增的 `async` 属性

### <h3 id="5.2">减少 DOM 操作</h3>

JavaScript 操作 DOM 很慢，尤其是 DOM 节点很多时。

使用时应该注意：

- 缓存已经访问过的元素；
- 使用 `DocumentFragment` 暂存 DOM，整理好以后再插入 DOM 树；
- 操作 className，而不是多次读写 style；
- 避免使用 JavaScript 修复布局。

### <h3 id="5.3">使用外部 JavaScript 和 CSS</h3>

外部 JavaScript 和 CSS 文件可以被浏览器缓存，在不同页面间重用，也能降低页面大小。

当然，实际中也需要考虑代码的重用程度。如果仅仅是某个页面使用到的代码，可以考虑内嵌在页面中，减少 HTTP 请求数。另外，可以在首页加载完成以后，预先加载子页面的资源。

### <h3 id="5.4">压缩 JavaScript 和 CSS</h3>

压缩代码可以移除非功能性的字符（注释、空格、空行等），减少文件大小，提高载入速度。

> 得益于 Node.js 的流行，开源社区涌现出许多高效、易用的前端优化工具，JavaScript 和 CSS 压缩类的，如 [UglifyJS 2](https://github.com/mishoo/UglifyJS2)、csso、cssnano 等。

> 对于内嵌的 CSS 和 JavaScript，也可以通过 htmlmin 等工具压缩。

> 这些项目都有 Gulp、Webpack 等流行构建工具的配套版本。

## <h2 id="6">图片</h2>

### <h3 id="6.1">压缩图片</h3>

压缩图片最直接带来的就是减少图片的大小，从而缩短请求时间。

图片压缩的方式有：

1. 缩小图片分辨率；
2. 改变图片格式；
3. 降低图片保存质量。

### <h3 id="6.2">CSS Sprites</h3>

CSS Sprites：是将多张图片合并成一张图片达到减少 HTTP 请求的一种解决方案，可以通过 background-image 和 background-position 属性来访问图片内容。这种方案同时还可以减少图片总字节数，节省命名词汇量（由命名多张图片文件变成一张）。


## 优秀文章

- [Optimising the front end for the browser](https://hackernoon.com/optimising-the-front-end-for-the-browser-f2f51a29c572)
- 译文: [优化浏览器前端](http://mp.weixin.qq.com/s/XMZvK7hRz4Fw2srqZXvXAA)
